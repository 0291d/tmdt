# Q&A Ch·ª©c nƒÉng D·ª± √°n (Laravel 9)

## üîê ƒêƒÉng k√Ω / ƒêƒÉng nh·∫≠p
- C√†i ƒë·∫∑t auth: d√πng Laravel UI v·ªõi `Auth::routes()` v√† scaffolding controller/view m·∫∑c ƒë·ªãnh.
  - routes/web.php: `routes/web.php`
  - Controllers: `app/Http/Controllers/Auth/LoginController.php`, `app/Http/Controllers/Auth/RegisterController.php`, `app/Http/Controllers/Auth/ForgotPasswordController.php`, `app/Http/Controllers/Auth/ResetPasswordController.php`, `app/Http/Controllers/Auth/VerificationController.php`, `app/Http/Controllers/Auth/ConfirmPasswordController.php`
  - Views: `resources/views/auth/login.blade.php`, `resources/views/auth/register.blade.php`, `resources/views/auth/passwords/reset.blade.php`, ...
- Roles: 2 vai tr√≤ ch√≠nh l√† `user` v√† `admin` (c·ªôt `role` enum).
  - Migration users: `database/migrations/2014_10_12_000000_create_users_table.php`
  - B·∫£o v·ªá admin: `app/Http/Middleware/EnsureAdmin.php`, `app/Models/User.php:canAccessFilament()`, `app/Http/Kernel.php`
- Gi·ªõi h·∫°n ch·ªâ role ‚Äúuser‚Äù m·ªõi ƒë∆∞·ª£c b√¨nh lu·∫≠n: ki·ªÉm tra role trong route POST comment + middleware `auth`.
  - Route: `routes/web.php` (POST `/product/{product}/comments`)
- M·∫≠t kh·∫©u l∆∞u th·∫ø n√†o: bƒÉm b·∫±ng bcrypt qua `Hash::make` khi ƒëƒÉng k√Ω.
  - `app/Http/Controllers/Auth/RegisterController.php`
- `remember_token` d√πng ƒë·ªÉ ‚Äúremember me‚Äù (ghi nh·ªõ ƒëƒÉng nh·∫≠p) trong phi√™n l√†m vi·ªác d√†i.
  - `database/migrations/2014_10_12_000000_create_users_table.php`
- Sanctum / API token: c√≥ d√πng Sanctum (`HasApiTokens` tr√™n `App\Models\User`) v√† route m·∫´u `/api/user`.
  - `composer.json`, `app/Models/User.php`, `routes/api.php`
- C∆° ch·∫ø b·∫£o m·∫≠t Laravel s·ª≠ d·ª•ng: CSRF (`App\Http\Middleware\VerifyCsrfToken` trong nh√≥m `web`), hash m·∫≠t kh·∫©u, session auth, middleware `auth`, (c√≥ s·∫µn c·∫•u tr√∫c email verification n·∫øu b·∫≠t), throttle cho API.
  - `app/Http/Kernel.php`, `app/Http/Middleware/VerifyCsrfToken.php`

## üõçÔ∏è Duy·ªát s·∫£n ph·∫©m, t√¨m ki·∫øm & l·ªçc
- Hi·ªÉn th·ªã danh s√°ch: `ShopController@index` l·∫•y categories (k√®m t·ªïng s·∫£n ph·∫©m), brands (group), v√† products (eager load images) theo th·ª© t·ª± m·ªõi nh·∫•t.
  - `app/Http/Controllers/ShopController.php`
- T√¨m ki·∫øm theo t√™n/brand/m√¥ t·∫£: s·ª≠ d·ª•ng `LIKE` trong where nh√≥m theo t·ª´ kh√≥a `q`.
  - `app/Http/Controllers/ShopController.php`
- L·ªçc theo danh m·ª•c/brand: c√°c action `category($id)` v√† `brand($brand)` tr·∫£ v·ªÅ c√πng view.
  - `app/Http/Controllers/ShopController.php`
- Ph√¢n trang (pagination): c√≥, `paginate(12)`/`paginate(12)->appends(...)`.
  - `app/Http/Controllers/ShopController.php`


## üí¨ Chi ti·∫øt s·∫£n ph·∫©m & b√¨nh lu·∫≠n
- Xem chi ti·∫øt: `ProductController@show` n·∫°p `images`, `detail` v√† danh s√°ch b√¨nh lu·∫≠n (k√®m user) r·ªìi r ender view.
  - `app/Http/Controllers/ProductController.php`, `resources/views/pages/product/show.blade.php`
- C·∫•u tr√∫c b·∫£ng `comments`: `id` (UUID), `user_id` (bigint FK users), `product_id` (UUID FK products), `content`, timestamps.
  - `database/migrations/2025_09_07_151833_create_comments_table.php`
- NgƒÉn ng∆∞·ªùi ch∆∞a ƒëƒÉng nh·∫≠p b√¨nh lu·∫≠n: route d√πng `middleware('auth')` v√† trong handler ki·ªÉm tra `role === user` m·ªõi cho t·∫°o.
  - `routes/web.php` (POST `/product/{product}/comments`)
- Quan h·ªá 1‚Äì1 products ‚Üî product_details: `Product::hasOne(ProductDetail::class)`, FK `product_details.product_id`.
  - `app/Models/Product.php`, `database/migrations/2025_08_30_194024_create_product_details_table.php`
- S·ª≠a/xo√° b√¨nh lu·∫≠n: ch∆∞a c√≥ ·ªü FE; ph√≠a Admin c√≥ th·ªÉ CRUD qua Filament.
  - `app/Filament/Resources/CommentResource.php`

## üõí Gi·ªè h√†ng & M√£ gi·∫£m gi√°
- C∆° ch·∫ø: l∆∞u gi·ªè h√†ng trong session (`session('cart')`), m√£ gi·∫£m gi√° trong session (`session('coupon')`).
  - Routes: `routes/web.php` (GET `/cart`, POST `/cart/add`, `/cart/update`, `/cart/remove`, `/cart/coupon`, `/cart/coupon/remove`)
- ‚ÄúTh√™m v√†o gi·ªè‚Äù: load s·∫£n ph·∫©m + ·∫£nh ch√≠nh, g·ªôp s·ªë l∆∞·ª£ng n·∫øu ƒë√£ c√≥, r·ªìi ghi l·∫°i `session('cart')`.
  - `routes/web.php` (POST `/cart/add`)
- D·ªØ li·ªáu gi·ªè h√†ng l∆∞u ·ªü ƒë√¢u/t·ªìn t·∫°i bao l√¢u: l∆∞u trong session; th·ªùi gian ph·ª• thu·ªôc c·∫•u h√¨nh `session.lifetime` (ph√∫t) trong `config/session.php` v√† driver session.
- V√¨ sao kh√¥ng l∆∞u DB: ƒë∆°n gi·∫£n h√≥a, tr√°nh ghi DB li√™n t·ª•c cho ng∆∞·ªùi ch∆∞a checkout; kh√¥ng ƒë·ªìng b·ªô ƒëa thi·∫øt b·ªã (ch·∫•p nh·∫≠n ƒë√°nh ƒë·ªïi) nh∆∞ng nhanh v√† nh·∫π cho frontend.
- √Åp d·ª•ng m√£ gi·∫£m gi√°: validate `code`, ki·ªÉm tra t·ªìn t·∫°i, h·∫°n d√πng, s·ªë l∆∞·ª£t, sau ƒë√≥ set `session('coupon') = {id, code, percent}`.
  - `routes/web.php` (POST `/cart/coupon`)
- H·ªßy m√£ gi·∫£m gi√°: xo√° `session('coupon')`.
  - `routes/web.php` (POST `/cart/coupon/remove`)
- T√≠nh t·ªïng ti·ªÅn + gi·∫£m gi√°: d√πng `Order::totalsFromCart($cart, $coupon)` ƒë·ªÉ t√≠nh `subtotal`, `%`, `discount_amount`, `final_total`.
  - `app/Models/Order.php`
- Ki·ªÉm tra t·ªìn kho khi th√™m gi·ªè: hi·ªán ch∆∞a c√≥ ·ªü FE route; c√≥ th·ªÉ b·ªï sung check `stock` c·ªßa product tr∆∞·ªõc khi tƒÉng s·ªë l∆∞·ª£ng.

## üíñ Wishlist, H·ªì s∆° ng∆∞·ªùi d√πng & ƒê∆°n h√†ng
- B·∫£ng `wishlists`: `id` (UUID), `user_id` (FK users), `product_id` (UUID FK products), timestamps, unique `(user_id, product_id)` ƒë·ªÉ ngƒÉn tr√πng m·ªôt s·∫£n ph·∫©m cho c√πng user.
  - `database/migrations/2025_09_16_000001_create_wishlists_table.php`
- Tr√°nh th√™m tr√πng: `WishlistController@add` ki·ªÉm tra `exists()` tr∆∞·ªõc khi `create()`.
  - `app/Http/Controllers/WishlistController.php`
- Ch∆∞a ƒëƒÉng nh·∫≠p m√† b·∫•m ‚ÄúTh√™m v√†o wishlist‚Äù: route thu·ªôc nh√≥m `auth` ‚Üí s·∫Ω chuy·ªÉn h∆∞·ªõng t·ªõi `/login`.
  - `routes/web.php`
- H·ªì s∆° ng∆∞·ªùi d√πng: hi·ªÉn th·ªã th√¥ng tin `User` (name/email) v√† `Customer` (phone/address); c·∫≠p nh·∫≠t qua `UserInformationController@update`.
  - `resources/views/pages/user_information.blade.php`, `app/Http/Controllers/UserInformationController.php`
- L·ªãch s·ª≠ ƒë∆°n h√†ng: t√¨m `Customer` theo `user_id`, l·∫•y `Order` k√®m `items.product.images` cho customer ƒë√≥.
  - `app/Http/Controllers/OrderController.php`, `resources/views/pages/orders/history.blade.php`
- `orders` vs `order_items`: `orders` (ƒë∆°n t·ªïng, tr·∫°ng th√°i, coupon, total), `order_items` (c√°c d√≤ng s·∫£n ph·∫©m: product_id, quantity, price).
  - `database/migrations/2025_08_30_192629_create_orders_table.php`, `database/migrations/2025_08_30_192752_create_order-items_table.php`, `database/migrations/2025_09_13_182416_add_timestamps_to_order_items_table.php`
- Tr·∫°ng th√°i ƒë∆°n h√†ng d√πng ENUM: l·ª£i √≠ch (r√†ng bu·ªôc gi√° tr·ªã h·ª£p l·ªá, d·ªÖ ƒë·ªçc); h·∫°n ch·∫ø (ƒë·ªïi/expand c·∫ßn migration, kh√≥ i18n tr·ª±c ti·∫øp, ph·ª• thu·ªôc DB).
  - `database/migrations/2025_08_30_192629_create_orders_table.php`
- UUID l√†m kho√° ch√≠nh: ∆∞u (kh√≥ ƒëo√°n ID, ph√π h·ª£p h·ªá ph√¢n t√°n, tr√°nh l·ªô s·ªë l∆∞·ª£ng b·∫£n ghi); nh∆∞·ª£c (index l·ªõn h∆°n, join ch·∫≠m h∆°n so v·ªõi int).
  - Model d√πng `HasUuids`: `app/Models/Product.php`, `app/Models/Order.php`, `app/Models/Image.php`, ...
- UUID t·∫°o th·∫ø n√†o: Laravel trait `HasUuids` (d·ª±a tr√™n `Str::uuid()`) t·ª± set khi t·∫°o model.
- V√¨ sao c√†i `doctrine/dbal`: ƒë·ªÉ h·ªó tr·ª£ `->change()` khi ƒë·ªïi ki·ªÉu c·ªôt (vd tƒÉng precision ti·ªÅn t·ªá l√™n `decimal(15,2)`).
  - `composer.json`, `database/migrations/2025_09_18_111104_adjust_price_precision.php`
- C√≥ d√πng trigger MySQL kh√¥ng: kh√¥ng d√πng trigger; d√πng `DEFAULT CURRENT_TIMESTAMP` + `ON UPDATE CURRENT_TIMESTAMP` cho `updated_at` qua migration.
  - `database/migrations/2025_09_17_180500_update_timestamp_triggers_for_updated_at.php`

## üñºÔ∏è H√¨nh ·∫£nh & Polymorphic
- `imageable_id` v√† `imageable_type`: c·∫∑p c·ªôt ƒë·ªÉ √°nh x·∫° ƒëa h√¨nh (morph) cho nhi·ªÅu th·ª±c th·ªÉ c√≥ ·∫£nh (Product, News...).
  - Migration: `database/migrations/2025_08_30_183334_create_images_table.php`
  - Model: `app/Models/Image.php` (quan h·ªá `morphTo()` v√† accessor `url` qua disk `public`)
- L∆∞u tr·ªØ ·∫£nh: d√πng `Storage::disk('public')` ‚Üí URL public t·ª´ `storage/app/public` (c·∫ßn symbolic link t·ªõi `public/storage`).
  - `app/Models/Image.php`
- X√°c th·ª±c ƒë·ªãnh d·∫°ng ·∫£nh: ch∆∞a th·∫•y logic ri√™ng ·ªü FE; ph·∫ßn Admin c√≥ th·ªÉ c·∫•u h√¨nh validation trong c√°c Filament Resource khi d√πng field upload.

## üßë‚Äçüíª Khu v·ª±c qu·∫£n tr·ªã (Admin)
- Ch·ªâ admin truy c·∫≠p `/admin`: middleware `EnsureAdmin` ch·∫∑n route `/admin*`; Filament c≈©ng ki·ªÉm tra `User::canAccessFilament()` tr·∫£ v·ªÅ true khi `role=admin`.
  - `app/Http/Middleware/EnsureAdmin.php`, `app/Models/User.php`, `app/Http/Kernel.php`
- Admin l√†m g√¨: CRUD cho Category, Product, Order, OrderItem, Coupon, Comment, Contact, Customer, Image, User, Wishlist; trang t√πy ch·ªânh ProductStats.
  - `app/Filament/Resources/*`, `app/Filament/Pages/ProductStats.php`, `resources/views/filament/pages/product-stats.blade.php`
- L√Ω do d√πng g√≥i c√≥ s·∫µn: t·ªëc ƒë·ªô ph√°t tri·ªÉn nhanh, UI/UX t·ªët, c√≥ s·∫µn form/table/search/filter, policy & authorization t√≠ch h·ª£p, gi·∫£m l·ªói l·∫∑p.

## üí≥ Thanh to√°n VNPAY & SEPay
- Lu·ªìng VNPAY:
  1) Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p, c√≥ `Customer` (phone/address) v√† c√≥ gi·ªè h√†ng session.
  2) `PaymentController@vnpayPayment` t√≠nh t·ªïng, t·∫°o b·∫£n ghi `payments` ·ªü tr·∫°ng th√°i `pending`, k√Ω HMAC v√† redirect sang VNPAY.
  3) VNPAY redirect v·ªÅ `payment.vnpay.return` k√®m tham s·ªë `vnp_*`.
  4) `PaymentController@vnpayReturn` x√°c th·ª±c HMAC, n·∫øu th√†nh c√¥ng th√¨ t·∫°o `orders` + `order_items`, c·∫≠p nh·∫≠t `payments` (`success`), tƒÉng `coupons.used_count`, xo√° session cart/coupon.
  - `app/Http/Controllers/PaymentController.php`, `routes/web.php`
- Callback VNPAY: endpoint `GET /payment/vnpay/return` (kh√¥ng b·∫Øt bu·ªôc auth do tr√¨nh duy·ªát quay v·ªÅ).
  - `routes/web.php`
- X√°c th·ª±c callback: s·∫Øp x·∫øp params `vnp_*`, bƒÉm HMAC `sha512` v·ªõi `VNPAY_HASH_SECRET` v√† so s√°nh `vnp_SecureHash`.
  - `app/Http/Controllers/PaymentController.php`
- C·∫≠p nh·∫≠t ƒë∆°n h√†ng sau thanh to√°n: t·∫°o Order + c√°c OrderItem t·ª´ session cart, li√™n k·∫øt coupon n·∫øu c√≤n h·∫°n v√† s·ªë l∆∞·ª£t, ƒë·ªïi tr·∫°ng th√°i `paid`.
  - `app/Http/Controllers/PaymentController.php`, `app/Models/Order.php`
- Tr∆∞·ªùng h·ª£p ƒë√≥ng tr√¨nh duy·ªát gi·ªØa ch·ª´ng: n·∫øu kh√¥ng quay v·ªÅ callback, payment v·∫´n ·ªü tr·∫°ng th√°i `pending` (ghi nh·∫≠n ƒë·ªÉ ƒë·ªëi so√°t), ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c t·∫°o.
- Vai tr√≤ b·∫£ng `payments`: l∆∞u log giao d·ªãch (provider, s·ªë ti·ªÅn, m√£ tham chi·∫øu, m√£ ng√¢n h√†ng, tr·∫°ng th√°i, th·ªùi ƒëi·ªÉm thanh to√°n, payload tr·∫£ v·ªÅ), li√™n k·∫øt order.
  - `database/migrations/2025_09_20_120000_create_payments_table.php`
- SEPay: b·∫£ng `sepay_transactions` ƒë·ªÉ l∆∞u c√°c giao d·ªãch t·ª´ SEPay; lu·ªìng t√≠ch h·ª£p FE ch∆∞a ƒë∆∞·ª£c n·ªëi v√†o controller trong repo n√†y.
  - `database/migrations/2025_09_19_103539_create_sepay_table.php`

## üì∞ Trang Tin t·ª©c & Li√™n h·ªá
- Tin t·ª©c: l∆∞u ·ªü b·∫£ng ri√™ng `news`, c√≥ CRUD b√™n Admin; FE c√≥ `NewsController@index|show` v√† views t∆∞∆°ng ·ª©ng.
  - `database/migrations/2025_08_30_181754_create_news_table.php`, `app/Http/Controllers/NewsController.php`, `resources/views/pages/news/index.blade.php`, `resources/views/pages/news/show.blade.php`
- Li√™n h·ªá: form `/contact` validate d·ªØ li·ªáu v√† `Contact::create(...)` ƒë·ªÉ l∆∞u v√†o b·∫£ng `contacts`.
  - Route: `routes/web.php` (GET/POST `/contact`)
  - B·∫£ng/Model: `database/migrations/2025_09_13_200000_create_contacts_table.php`, `database/migrations/2025_09_17_120100_add_customer_id_to_contacts_table.php`, `app/Models/Contact.php`

